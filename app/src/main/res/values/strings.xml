package com.livescreensaver.tv

import android.content.ComponentName
import android.content.Intent
import android.os.Bundle
import android.widget.Toast
import androidx.preference.EditTextPreference
import androidx.preference.Preference
import androidx.preference.PreferenceFragmentCompat
import androidx.preference.SwitchPreferenceCompat
import androidx.preference.ListPreference
import androidx.appcompat.app.AppCompatActivity

class SettingsActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_settings)
        
        if (savedInstanceState == null) {
            supportFragmentManager
                .beginTransaction()
                .replace(R.id.settings_container, SettingsFragment())
                .commit()
        }
        
        supportActionBar?.setDisplayHomeAsUpEnabled(true)
    }
    
    class SettingsFragment : PreferenceFragmentCompat() {
        private lateinit var preferenceManager: PreferenceManager
        
        override fun onCreatePreferences(savedInstanceState: Bundle?, rootKey: String?) {
            setPreferencesFromResource(R.xml.preferences, rootKey)
            
            preferenceManager = PreferenceManager(requireContext())
            
            setupStreamUrl()
            setupDisplaySettings()
            setupPlaybackSettings()
            setupScheduleSettings()
            setupAdvancedSettings()
            setupTestScreensaver()
        }
        
        private fun setupStreamUrl() {
            findPreference<EditTextPreference>("stream_url")?.apply {
                summary = preferenceManager.getStreamUrl().ifEmpty { 
                    getString(R.string.stream_url_hint) 
                }
                
                setOnPreferenceChangeListener { _, newValue ->
                    val url = newValue as String
                    if (url.isNotEmpty() && isValidUrl(url)) {
                        preferenceManager.setStreamUrl(url)
                        summary = url
                        true
                    } else {
                        Toast.makeText(
                            requireContext(), 
                            R.string.invalid_url, 
                            Toast.LENGTH_SHORT
                        ).show()
                        false
                    }
                }
            }
        }
        
        private fun setupDisplaySettings() {
            findPreference<SwitchPreferenceCompat>("show_clock")?.apply {
                isChecked = preferenceManager.getShowClock()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setShowClock(newValue as Boolean)
                    true
                }
            }
            
            findPreference<SwitchPreferenceCompat>("show_date")?.apply {
                isChecked = preferenceManager.getShowDate()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setShowDate(newValue as Boolean)
                    true
                }
            }
            
            findPreference<SwitchPreferenceCompat>("show_channel_name")?.apply {
                isChecked = preferenceManager.getShowChannelName()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setShowChannelName(newValue as Boolean)
                    true
                }
            }
            
            findPreference<SwitchPreferenceCompat>("show_channel_logo")?.apply {
                isChecked = preferenceManager.getShowChannelLogo()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setShowChannelLogo(newValue as Boolean)
                    true
                }
            }
        }
        
        private fun setupPlaybackSettings() {
            findPreference<SwitchPreferenceCompat>("auto_quality")?.apply {
                isChecked = preferenceManager.getAutoQuality()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setAutoQuality(newValue as Boolean)
                    findPreference<ListPreference>("preferred_quality")?.isEnabled = !(newValue as Boolean)
                    true
                }
            }
            
            findPreference<ListPreference>("preferred_quality")?.apply {
                isEnabled = !preferenceManager.getAutoQuality()
                value = preferenceManager.getPreferredQuality()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setPreferredQuality(newValue as String)
                    true
                }
            }
        }
        
        private fun setupScheduleSettings() {
            findPreference<SwitchPreferenceCompat>("enable_schedule")?.apply {
                isChecked = preferenceManager.getScheduleEnabled()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setScheduleEnabled(newValue as Boolean)
                    val enabled = newValue as Boolean
                    findPreference<Preference>("start_time")?.isEnabled = enabled
                    findPreference<Preference>("end_time")?.isEnabled = enabled
                    true
                }
            }
            
            val scheduleEnabled = preferenceManager.getScheduleEnabled()
            findPreference<Preference>("start_time")?.isEnabled = scheduleEnabled
            findPreference<Preference>("end_time")?.isEnabled = scheduleEnabled
        }
        
        private fun setupAdvancedSettings() {
            findPreference<SwitchPreferenceCompat>("enable_logging")?.apply {
                isChecked = preferenceManager.getLoggingEnabled()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setLoggingEnabled(newValue as Boolean)
                    true
                }
            }
            
            findPreference<ListPreference>("buffer_size")?.apply {
                value = preferenceManager.getBufferSize().toString()
                setOnPreferenceChangeListener { _, newValue ->
                    preferenceManager.setBufferSize((newValue as String).toInt())
                    true
                }
            }
        }
        
        private fun setupTestScreensaver() {
            findPreference<Preference>("test_screensaver")?.apply {
                setOnPreferenceClickListener {
                    launchScreensaver()
                    true
                }
            }
        }
        
        private fun launchScreensaver() {
            val streamUrl = preferenceManager.getStreamUrl()
            
            if (streamUrl.isEmpty()) {
                Toast.makeText(
                    requireContext(),
                    R.string.url_required,
                    Toast.LENGTH_SHORT
                ).show()
                return
            }
            
            try {
                val intent = Intent(Intent.ACTION_ATTACH_DATA).apply {
                    component = ComponentName(
                        requireContext(),
                        LiveScreensaverService::class.java
                    )
                    addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                }
                
                // Start the screensaver service directly
                requireContext().startService(
                    Intent(requireContext(), LiveScreensaverService::class.java)
                )
                
                Toast.makeText(
                    requireContext(),
                    "Launching screensaver...",
                    Toast.LENGTH_SHORT
                ).show()
                
            } catch (e: Exception) {
                Toast.makeText(
                    requireContext(),
                    "Error launching screensaver: ${e.message}",
                    Toast.LENGTH_LONG
                ).show()
            }
        }
        
        private fun isValidUrl(url: String): Boolean {
            return url.startsWith("http://") || 
                   url.startsWith("https://") ||
                   url.startsWith("rtmp://") ||
                   url.startsWith("rtsp://")
        }
    }
}
